server {
    listen 80;
    index index.php;
    root /var/www/public; # Define a raiz como a pasta 'public'
    charset utf-8;

    # --- CORREÇÃO DO LIMITE DE UPLOAD (Erro 413) ---
    # Aumenta o limite de upload do Nginx (o padrão é 1MB)
    # 3M é um valor seguro para o nosso limite de 2M do PHP.
    client_max_body_size 3M; 

    # --- CORREÇÃO DO ROUTER (Erro 404 em ficheiros) ---
    # Este é o "apanha-tudo".
    location / {
        # 1. Tenta encontrar o ficheiro exato ($uri) (ex: /uploads/img.png)
        # 2. Se não, tenta ver se é uma pasta ($uri/)
        # 3. Se falhar, envia o pedido para o index.php (o seu router)
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # Este bloco agora trata APENAS de pedidos .php
    location ~ \.php$ {
        # Passa o pedido para o container 'php' (definido no docker-compose.yml)
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        
        # Define o ficheiro exato que o PHP deve executar
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # Inclui os parâmetros PHP-FPM padrão
        include fastcgi_params;
        
        # Medidas de segurança e compatibilidade
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
    }

    # Nega o acesso a ficheiros .ht (boa prática)
    location ~ /\.ht {
        deny all;
    }
}